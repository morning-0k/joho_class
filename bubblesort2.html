<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>バブルソート体験ツール（右から決定版）</title>
    <!-- Tailwind CSSを読み込みます -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interフォントを読み込みます */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        /* カードのトランジションを滑らかにします */
        .sort-card {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl max-w-lg w-full">
        
        <!-- タイトル -->
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-6">
            バブルソート体験ツール
        </h1>

        <!-- カード表示エリア -->
        <div id="card-container" class="flex justify-around items-center h-40 bg-blue-100 p-4 rounded-lg mb-6 shadow-inner">
            <!-- カードはJavaScriptによってここに挿入されます -->
        </div>

        <!-- 説明エリア -->
        <div id="explanation" class="text-center text-gray-700 text-lg min-h-[2.5em] mb-6 font-medium">
            リセットボタンで初期化してください。
        </div>

        <!-- 操作ボタンエリア -->
        <div class="grid grid-cols-3 gap-3">
            <button id="autoPlayBtn" class="bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed">
                自動再生
            </button>
            <button id="nextStepBtn" class="bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed">
                次へ
            </button>
            <button id="resetBtn" class="bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-gray-700 transition-colors duration-200">
                リセット
            </button>
        </div>

    </div>

    <script>
        // DOMが読み込まれてからスクリプト全体を実行するように変更
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DOM要素の取得 ---
            const cardContainer = document.getElementById('card-container');
            const explanation = document.getElementById('explanation');
            const autoPlayBtn = document.getElementById('autoPlayBtn');
            const nextStepBtn = document.getElementById('nextStepBtn');
            const resetBtn = document.getElementById('resetBtn');

            // --- 初期データと状態管理 ---
            const initialCards = [4, 2, 5, 1, 3]; // 5要素
            let cards = [...initialCards];
            const n = cards.length;
            let i = 0; // 外側ループ（パス）
            let j = 0; // 内側ループ（比較） ※初期値を変更
            let isSorting = false;
            let isSorted = false;
            const SORT_SPEED = 800; // 自動再生の速度 (ms)

            // --- ユーティリティ関数 ---

            /**
             * 指定時間待機する非同期関数
             * @param {number} ms - 待機するミリ秒
             */
            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            /**
             * カードのDOMを現在の配列状態に基づいて描画する
             * @param {number} compareIdx1 - 比較対象1のインデックス
             * @param {number} compareIdx2 - 比較対象2のインデックス
             * @param {boolean} isSwapping - 交換が発生したか
             */
            function renderCards(compareIdx1 = -1, compareIdx2 = -1, isSwapping = false) {
                cardContainer.innerHTML = '';
                cards.forEach((value, index) => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'sort-card w-16 h-24 sm:w-20 sm:h-28 bg-white border-2 border-gray-300 rounded-lg flex items-center justify-center text-3xl font-bold shadow-sm transition-all duration-300 ease-in-out';
                    cardDiv.textContent = value;

                    // 比較中・交換中のスタイルを適用
                    if (index === compareIdx1 || index === compareIdx2) {
                        if (isSwapping) {
                            // 交換時
                            cardDiv.classList.add('border-red-500', 'bg-red-100', 'scale-105', 'shadow-lg');
                        } else {
                            // 比較時
                            cardDiv.classList.add('border-blue-500', 'scale-105', 'shadow-lg');
                        }
                    }
                    
                    // ソート完了済みの部分をグレーアウト (右から確定)
                    if (index >= n - i) { // 変更: n - i 以上のインデックスを確定済みとする
                         cardDiv.classList.add('bg-gray-200', 'border-gray-400', 'opacity-75');
                    }

                    cardContainer.appendChild(cardDiv);
                });
            }

            /**
             * ボタンの有効/無効状態を更新する
             */
            function updateButtons() {
                autoPlayBtn.disabled = isSorting || isSorted;
                nextStepBtn.disabled = isSorting || isSorted;
                resetBtn.disabled = false;
            }

            /**
             * ソート状態を初期化する
             */
            function reset() {
                cards = [...initialCards];
                i = 0;
                j = 0; // jの初期値を変更
                isSorting = false;
                isSorted = false;
                
                renderCards();
                explanation.textContent = "「自動再生」か「次へ」で開始します。";
                updateButtons();
            }

            /**
             * バブルソートの次の1ステップを実行する
             * @param {boolean} isAuto - 自動再生モードか
             */
            async function nextStep(isAuto = false) {
                // 処理中 or 完了済みなら何もしない
                if ((!isAuto && isSorting) || isSorted) return;

                if (!isAuto) {
                    isSorting = true; // 手動実行の場合のみisSortingを管理
                }
                updateButtons();

                // iがn-1に達したらソート完了
                if (i >= n - 1) {
                    explanation.textContent = "ソートが完了しました！";
                    isSorted = true;
                    isSorting = false;
                    i++; // 最後の要素もグレーアウトするためにiを+1
                    renderCards(); // 全てを完了状態に
                    updateButtons();
                    return;
                }

                // 1. 比較対象を表示 (j と j+1 を比較)
                const val1 = cards[j];
                const val2 = cards[j+1];
                explanation.textContent = `${val1} と ${val2} を比較します。`;
                renderCards(j, j + 1, false); // 変更: j と j+1 をハイライト

                if (isAuto) await sleep(SORT_SPEED);

                // 2. 比較と交換のロジック
                if (val1 > val2) {
                    explanation.textContent = `${val1} > ${val2} なので交換します。`;
                    // 値を交換
                    [cards[j], cards[j+1]] = [val2, val1]; // 変更: j と j+1 を交換
                    // 交換後のビジュアルを表示
                    renderCards(j, j + 1, true); // 変更: j と j+1 をハイライト
                    if (isAuto) await sleep(SORT_SPEED);
                } else {
                    explanation.textContent = `${val1} ≦ ${val2} なので交換しません。`;
                    if (isAuto) await sleep(SORT_SPEED);
                }
                
                // 3. 次の比較へ
                j++; // 変更: jをインクリメント（右へ移動）

                // 4. 内側ループの終わり（1パスの終わり）
                if (j >= n - 1 - i) { // 変更: jが (n - 1 - i) 以上になったらパス終了
                    // パス終了。次のパスへ
                    j = 0; // 変更: jを左端にリセット
                    i++; // 変更: 次の確定位置へ
                    // パス終了時に一旦ハイライトを消す
                    renderCards();
                    if (isAuto) await sleep(SORT_SPEED / 2);
                }

                // 5. 処理完了
                if (!isAuto) {
                    isSorting = false; // 手動実行の場合のみisSortingを管理
                }
                updateButtons();
            }

            /**
             * 自動再生を開始する
             */
            async function autoPlay() {
                isSorting = true;
                updateButtons();
                
                // isSortingがtrueの間（リセットが押されるまで）かつソート完了までループ
                while (isSorting && !isSorted) {
                    await nextStep(true);
                    // 各ステップ間の短いポーズ
                    if (isSorting && !isSorted) { // リセットで中断された場合、sleepしない
                       await sleep(SORT_SPEED / 4);
                    }
                }
                
                isSorting = false;
                updateButtons();
            }

            // --- イベントリスナーの設定 ---
            autoPlayBtn.addEventListener('click', autoPlay);
            nextStepBtn.addEventListener('click', () => nextStep(false));
            resetBtn.addEventListener('click', reset);

            // --- 初期化 ---
            reset();
        
        }); // DOMContentLoaded の終了
    </script>
</body>
</html>